<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - Financial Analysis</title>
    <link rel="stylesheet" href="/static/css/style.css?v=8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-header">
                <i class="fas fa-wallet"></i>
                <h1>ExpenseTracker</h1>
                <p>Sign in to continue</p>
            </div>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" class="form-control" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter password" required>
                </div>
                <div id="loginError" class="login-error" style="display: none;"></div>
                <button type="submit" class="btn btn-primary btn-login">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
            </form>
            <div class="login-footer">
                <small>Default: admin / money</small>
            </div>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <!-- Mobile sidebar overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <i class="fas fa-wallet"></i>
                <h1>ExpenseTracker</h1>
                <button class="sidebar-close" id="sidebarClose" title="Close menu">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <nav class="nav-menu">
                <ul>
                    <li><a href="#dashboard" class="nav-link active" data-page="dashboard"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                    <li class="has-submenu">
                        <a href="#transactions" class="nav-link" data-page="transactions">
                            <i class="fas fa-exchange-alt"></i> Transactions
                            <i class="fas fa-chevron-down submenu-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <li><a href="#rules" class="nav-link sub-link" data-page="rules"><i class="fas fa-filter"></i> Categorization Rules</a></li>
                        </ul>
                    </li>
                    <li><a href="#categories" class="nav-link" data-page="categories"><i class="fas fa-tags"></i> Categories</a></li>
                    <li><a href="#budgets" class="nav-link" data-page="budgets"><i class="fas fa-piggy-bank"></i> Budgets</a></li>
                    <li class="has-submenu">
                        <a href="#reports" class="nav-link" data-page="reports">
                            <i class="fas fa-chart-bar"></i> Reports
                            <i class="fas fa-chevron-down submenu-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <li><a href="#charts-summaries" class="nav-link sub-link" data-page="charts-summaries"><i class="fas fa-chart-pie"></i> Charts & Summaries</a></li>
                        </ul>
                    </li>
                    <li><a href="#upload" class="nav-link" data-page="upload"><i class="fas fa-upload"></i> Upload</a></li>
                    <li><a href="#settings" class="nav-link" data-page="settings"><i class="fas fa-cog"></i> Settings</a></li>
                </ul>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 id="pageTitle">Dashboard</h2>
                </div>
                <div class="header-right">
                    <div class="date-selector">
                        <select id="calendarTypeSelect" class="form-control" title="Calendar Type">
                            <option value="gregorian">Gregorian</option>
                            <option value="badi">Badí' (Bahá'í)</option>
                        </select>
                        <select id="periodSelect" class="form-control">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly" selected>Monthly</option>
                            <option value="annual">Annual</option>
                        </select>
                        <input type="month" id="monthPicker" class="form-control">
                        <select id="badiMonthPicker" class="form-control" style="display: none;">
                            <!-- Badí' months will be populated by JavaScript -->
                        </select>
                        <select id="badiYearPicker" class="form-control" style="display: none;">
                            <!-- Badí' years will be populated by JavaScript -->
                        </select>
                        <button class="btn btn-primary btn-apply-calendar" id="applyCalendarBtn" title="Apply Date Filter">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                    <div class="user-menu">
                        <button class="btn btn-user" id="userMenuBtn">
                            <i class="fas fa-user-circle"></i>
                            <span id="currentUserDisplay">User</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="user-info">
                                <span id="dropdownUsername">Username</span>
                                <span id="dropdownRole" class="role-badge">Role</span>
                            </div>
                            <hr>
                            <a href="#" id="changePasswordLink"><i class="fas fa-key"></i> Change Password</a>
                            <a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Page Content -->
            <div class="page-content">
                
                <!-- Dashboard Page -->
                <div id="dashboard" class="page active">
                    <div class="dashboard-grid">
                        <div class="stats-grid">
                            <div class="stat-card income">
                                <i class="fas fa-arrow-down"></i>
                                <h3>Total Income</h3>
                                <p class="amount" id="totalIncome">$0.00</p>
                            </div>
                            <div class="stat-card expense">
                                <i class="fas fa-arrow-up"></i>
                                <h3>Total Expense</h3>
                                <p class="amount" id="totalExpense">$0.00</p>
                            </div>
                            <div class="stat-card net">
                                <i class="fas fa-balance-scale"></i>
                                <h3>Net Balance</h3>
                                <p class="amount" id="netBalance">$0.00</p>
                            </div>
                            <div class="stat-card excluded">
                                <i class="fas fa-ban"></i>
                                <h3>Total Excluded</h3>
                                <p class="amount" id="totalExcluded">$0.00</p>
                            </div>
                        </div>
                        
                        <div class="charts-grid">
                            <div class="chart-container">
                                <h3>Expenses by Category</h3>
                                <canvas id="expenseChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3>Income by Category</h3>
                                <canvas id="incomeChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="category-breakdown">
                            <div class="breakdown-section">
                                <h3>Income by Category</h3>
                                <table class="breakdown-table">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Amount</th>
                                            <th>Count</th>
                                            <th>% of Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="incomeByCategory">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="breakdown-section">
                                <h3>Expenses by Category</h3>
                                <table class="breakdown-table">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Amount</th>
                                            <th>Count</th>
                                            <th>% of Total</th>
                                            <th>Avg per Transaction</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expenseByCategory">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="recent-transactions">
                            <h3>Recent Transactions</h3>
                            <div id="recentTransList" class="transaction-list">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Transactions Page -->
                <div id="transactions" class="page">
                    <div class="page-header">
                        <div class="search-bar">
                            <input type="text" id="searchInput" placeholder="Search transactions..." class="form-control">
                            <button class="btn btn-primary" id="addTransBtn">
                                <i class="fas fa-plus"></i> Add Transaction
                            </button>
                            <button class="btn btn-warning" id="bulkDeleteFileBtn">
                                <i class="fas fa-file-upload"></i> Delete by File
                            </button>
                        </div>
                        <div class="filters">
                            <select id="typeFilter" class="form-control">
                                <option value="">All Types</option>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                            <select id="categoryFilter" class="form-control">
                                <option value="">All Categories</option>
                                <!-- Populated by JavaScript -->
                            </select>
                            <select id="statusFilter" class="form-control">
                                <option value="included">Included</option>
                                <option value="excluded">Excluded</option>
                                <option value="all">All</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Hidden file input for bulk delete -->
                    <input type="file" id="bulkDeleteFile" style="display: none;" accept=".csv,.xlsx,.xls">
                    
                    <div class="transactions-table">
                        <div id="bulkDeleteToolbar" class="bulk-delete-toolbar" style="display: none;">
                            <span id="selectionCount">0 selected</span>
                            <button class="btn btn-danger" onclick="bulkDeleteSelected()">
                                <i class="fas fa-trash"></i> Delete Selected
                            </button>
                            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th class="checkbox-col">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)">
                                    </th>
                                    <th class="sortable" data-sort-field="date" onclick="sortTransactions('date')">Date <span class="sort-indicator"></span></th>
                                    <th class="sortable" data-sort-field="description" onclick="sortTransactions('description')">Description <span class="sort-indicator"></span></th>
                                    <th class="sortable" data-sort-field="category" onclick="sortTransactions('category')">Category <span class="sort-indicator"></span></th>
                                    <th class="sortable" data-sort-field="type" onclick="sortTransactions('type')">Type <span class="sort-indicator"></span></th>
                                    <th class="sortable" data-sort-field="amount" onclick="sortTransactions('amount')">Amount <span class="sort-indicator"></span></th>
                                    <th class="sortable" data-sort-field="status" onclick="sortTransactions('status')">Status <span class="sort-indicator"></span></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Budgets Page -->
                <div id="budgets" class="page">
                    <div class="page-header">
                        <button class="btn btn-primary" id="addBudgetBtn">
                            <i class="fas fa-plus"></i> Create Budget
                        </button>
                        <div class="filters">
                            <select id="budgetTypeFilter" class="form-control">
                                <option value="">All Categories</option>
                                <!-- Populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="budgets-grid" id="budgetsGrid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Reports Page -->
                <div id="reports" class="page">
                    <div class="reports-container">
                        <div class="report-section">
                            <h3>Spending Trends</h3>
                            <canvas id="trendingChart" style="max-height: 300px;"></canvas>
                        </div>
                        
                        <div class="report-section">
                            <h3>Budget vs Actual</h3>
                            <div id="budgetAnalysisContainer">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="report-section">
                            <h3>Category Breakdown</h3>
                            <div id="categoryBreakdown" class="category-table">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts & Summaries Page -->
                <div id="charts-summaries" class="page">
                    <div class="charts-summaries-container">
                        <!-- Controls Header -->
                        <div class="cs-controls no-print">
                            <div class="cs-control-group">
                                <label>Time Frame:</label>
                                <select id="csTimeFrameType" class="form-control">
                                    <option value="gregorian-month">Gregorian Month</option>
                                    <option value="gregorian-year">Gregorian Year</option>
                                    <option value="badi-month">Bahá'í Month</option>
                                    <option value="badi-year">Bahá'í Year</option>
                                    <option value="custom">Custom Date Range</option>
                                </select>
                            </div>
                            
                            <!-- Gregorian Month Selector -->
                            <div class="cs-control-group" id="csGregorianSelector">
                                <label>Month:</label>
                                <input type="month" id="csGregorianMonth" class="form-control">
                            </div>
                            
                            <!-- Gregorian Year Selector -->
                            <div class="cs-control-group" id="csGregorianYearSelector" style="display: none;">
                                <label>Year:</label>
                                <input type="number" id="csGregorianYear" class="form-control" min="1900" max="2100" style="width: 100px;">
                            </div>
                            
                            <!-- Bahá'í Month Selector -->
                            <div class="cs-control-group" id="csBadiSelector" style="display: none;">
                                <label>Year:</label>
                                <input type="number" id="csBadiYear" class="form-control" min="1" style="width: 80px;">
                                <label>Month:</label>
                                <select id="csBadiMonth" class="form-control">
                                    <!-- Populated by JavaScript -->
                                </select>
                            </div>
                            
                            <!-- Bahá'í Year Selector -->
                            <div class="cs-control-group" id="csBadiYearSelector" style="display: none;">
                                <label>Year:</label>
                                <input type="number" id="csBadiYearOnly" class="form-control" min="1" style="width: 100px;">
                            </div>
                            
                            <!-- Custom Date Range Selector -->
                            <div class="cs-control-group" id="csCustomSelector" style="display: none;">
                                <label>From:</label>
                                <input type="date" id="csCustomStart" class="form-control">
                                <label>To:</label>
                                <input type="date" id="csCustomEnd" class="form-control">
                            </div>
                            
                            <div class="cs-control-group">
                                <label>Chart Type:</label>
                                <select id="csChartType" class="form-control">
                                    <option value="bar">Bar Chart</option>
                                    <option value="line">Line Chart</option>
                                    <option value="pie">Pie Chart</option>
                                    <option value="doughnut">Doughnut Chart</option>
                                    <option value="polarArea">Polar Area</option>
                                    <option value="radar">Radar Chart</option>
                                </select>
                            </div>
                            
                            <button class="btn btn-primary" id="csGenerateBtn">
                                <i class="fas fa-sync"></i> Generate
                            </button>
                            
                            <div class="cs-print-dropdown">
                                <button class="btn btn-secondary" id="csPrintBtn">
                                    <i class="fas fa-print"></i> Print <i class="fas fa-caret-down"></i>
                                </button>
                                <div class="cs-print-menu" id="csPrintMenu">
                                    <button class="cs-print-option" data-orientation="portrait">
                                        <i class="fas fa-file"></i> Portrait
                                    </button>
                                    <button class="cs-print-option" data-orientation="landscape">
                                        <i class="fas fa-file" style="transform: rotate(90deg);"></i> Landscape
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Print Header (only visible when printing) -->
                        <div class="cs-print-header print-only">
                            <h1>Financial Summary Report</h1>
                            <p id="csPrintDateRange"></p>
                            <p id="csPrintGeneratedDate"></p>
                        </div>
                        
                        <!-- Summary Cards -->
                        <div class="cs-summary-cards">
                            <div class="cs-card income">
                                <div class="cs-card-icon"><i class="fas fa-arrow-down"></i></div>
                                <div class="cs-card-content">
                                    <h4>Total Income</h4>
                                    <p id="csTotalIncome">$0.00</p>
                                </div>
                            </div>
                            <div class="cs-card expense">
                                <div class="cs-card-icon"><i class="fas fa-arrow-up"></i></div>
                                <div class="cs-card-content">
                                    <h4>Total Expenses</h4>
                                    <p id="csTotalExpenses">$0.00</p>
                                </div>
                            </div>
                            <div class="cs-card net">
                                <div class="cs-card-icon"><i class="fas fa-balance-scale"></i></div>
                                <div class="cs-card-content">
                                    <h4>Net Balance</h4>
                                    <p id="csNetBalance">$0.00</p>
                                </div>
                            </div>
                            <div class="cs-card transactions">
                                <div class="cs-card-icon"><i class="fas fa-receipt"></i></div>
                                <div class="cs-card-content">
                                    <h4>Transactions</h4>
                                    <p id="csTransactionCount">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charts Section -->
                        <div class="cs-charts-section">
                            <div class="cs-chart-container">
                                <h3>Expense Breakdown by Category</h3>
                                <canvas id="csExpenseChart"></canvas>
                            </div>
                            <div class="cs-chart-container">
                                <h3>Income Breakdown by Category</h3>
                                <canvas id="csIncomeChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Comparison Section -->
                        <div class="cs-comparison-section">
                            <div class="cs-comparison-header">
                                <h3><i class="fas fa-balance-scale"></i> Period Comparison</h3>
                                <div class="cs-comparison-options">
                                    <div class="cs-comparison-toggle">
                                        <label>Chart Type:</label>
                                        <select id="csCompareChartType" class="form-control">
                                            <option value="bar">Bar Chart</option>
                                            <option value="line">Line Chart</option>
                                            <option value="pie">Pie Chart</option>
                                            <option value="doughnut">Doughnut</option>
                                            <option value="polarArea">Polar Area</option>
                                            <option value="radar">Radar</option>
                                        </select>
                                    </div>
                                    <div class="cs-comparison-toggle">
                                        <label>View Mode:</label>
                                        <select id="csCompareViewMode" class="form-control">
                                            <option value="side-by-side">Side by Side</option>
                                            <option value="overlay">Overlay</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="cs-comparison-controls no-print">
                                <!-- Period 1 -->
                                <div class="cs-period-selector">
                                    <h4><span class="cs-period-badge period-1">Period 1</span></h4>
                                    <div class="cs-period-row">
                                        <select id="csCompare1Type" class="form-control">
                                            <option value="gregorian-month">Gregorian Month</option>
                                            <option value="gregorian-year">Gregorian Year</option>
                                            <option value="badi-month">Bahá'í Month</option>
                                            <option value="badi-year">Bahá'í Year</option>
                                            <option value="custom">Custom Range</option>
                                        </select>
                                        <div class="cs-period-inputs" id="csCompare1Inputs">
                                            <input type="month" id="csCompare1Month" class="form-control">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Period 2 -->
                                <div class="cs-period-selector">
                                    <h4><span class="cs-period-badge period-2">Period 2</span></h4>
                                    <div class="cs-period-row">
                                        <select id="csCompare2Type" class="form-control">
                                            <option value="gregorian-month">Gregorian Month</option>
                                            <option value="gregorian-year">Gregorian Year</option>
                                            <option value="badi-month">Bahá'í Month</option>
                                            <option value="badi-year">Bahá'í Year</option>
                                            <option value="custom">Custom Range</option>
                                        </select>
                                        <div class="cs-period-inputs" id="csCompare2Inputs">
                                            <input type="month" id="csCompare2Month" class="form-control">
                                        </div>
                                    </div>
                                </div>
                                
                                <button class="btn btn-primary" id="csCompareBtn">
                                    <i class="fas fa-chart-bar"></i> Compare
                                </button>
                            </div>
                            
                            <!-- Comparison Charts -->
                            <div class="cs-comparison-results" id="csComparisonResults" style="display: none;">
                                <div class="cs-comparison-summary">
                                    <div class="cs-compare-card period-1">
                                        <h4 id="csCompare1Label">Period 1</h4>
                                        <div class="cs-compare-stats">
                                            <div><span>Income:</span> <strong id="csCompare1Income">$0.00</strong></div>
                                            <div><span>Expenses:</span> <strong id="csCompare1Expenses">$0.00</strong></div>
                                            <div><span>Net:</span> <strong id="csCompare1Net">$0.00</strong></div>
                                        </div>
                                    </div>
                                    <div class="cs-compare-card period-2">
                                        <h4 id="csCompare2Label">Period 2</h4>
                                        <div class="cs-compare-stats">
                                            <div><span>Income:</span> <strong id="csCompare2Income">$0.00</strong></div>
                                            <div><span>Expenses:</span> <strong id="csCompare2Expenses">$0.00</strong></div>
                                            <div><span>Net:</span> <strong id="csCompare2Net">$0.00</strong></div>
                                        </div>
                                    </div>
                                    <div class="cs-compare-card difference">
                                        <h4>Difference</h4>
                                        <div class="cs-compare-stats">
                                            <div><span>Income:</span> <strong id="csCompareDiffIncome">$0.00</strong></div>
                                            <div><span>Expenses:</span> <strong id="csCompareDiffExpenses">$0.00</strong></div>
                                            <div><span>Net:</span> <strong id="csCompareDiffNet">$0.00</strong></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Side by Side Charts -->
                                <div class="cs-comparison-charts side-by-side" id="csCompareSideBySide">
                                    <div class="cs-chart-container">
                                        <h3>Expenses Comparison</h3>
                                        <canvas id="csCompareExpenseChart"></canvas>
                                    </div>
                                    <div class="cs-chart-container">
                                        <h3>Income Comparison</h3>
                                        <canvas id="csCompareIncomeChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Overlay Charts -->
                                <div class="cs-comparison-charts overlay" id="csCompareOverlay" style="display: none;">
                                    <div class="cs-chart-container full-width">
                                        <h3>Expenses Comparison (Overlay)</h3>
                                        <canvas id="csCompareExpenseOverlay"></canvas>
                                    </div>
                                    <div class="cs-chart-container full-width">
                                        <h3>Income Comparison (Overlay)</h3>
                                        <canvas id="csCompareIncomeOverlay"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Print Button -->
                                <div class="cs-print-section no-print">
                                    <div class="cs-print-dropdown">
                                        <button class="btn btn-secondary" id="csComparePrintBtn">
                                            <i class="fas fa-print"></i> Print Comparison
                                        </button>
                                        <div class="cs-print-options" id="csComparePrintOptions">
                                            <button class="btn btn-outline" onclick="printComparison('portrait')">
                                                <i class="fas fa-file"></i> Portrait
                                            </button>
                                            <button class="btn btn-outline" onclick="printComparison('landscape')">
                                                <i class="fas fa-file-alt"></i> Landscape
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Detailed Tables -->
                        <div class="cs-tables-section">
                            <div class="cs-table-container">
                                <h3>Expense Details</h3>
                                <table class="cs-table">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Amount</th>
                                            <th>Percentage</th>
                                            <th>Transactions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="csExpenseTableBody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th>Total</th>
                                            <th id="csExpenseTableTotal">$0.00</th>
                                            <th>100%</th>
                                            <th id="csExpenseTableCount">0</th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <div class="cs-table-container">
                                <h3>Income Details</h3>
                                <table class="cs-table">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Amount</th>
                                            <th>Percentage</th>
                                            <th>Transactions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="csIncomeTableBody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th>Total</th>
                                            <th id="csIncomeTableTotal">$0.00</th>
                                            <th>100%</th>
                                            <th id="csIncomeTableCount">0</th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Top Transactions Section -->
                        <div class="cs-top-transactions">
                            <h3>Top 10 Transactions</h3>
                            <table class="cs-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="csTopTransactionsBody">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Categorization Rules Page -->
                <div id="rules" class="page">
                    <div class="page-header">
                        <button class="btn btn-primary admin-only" id="addRuleBtn">
                            <i class="fas fa-plus"></i> New Rule
                        </button>
                        <button class="btn btn-success" id="applyRulesBtn">
                            <i class="fas fa-sync"></i> Apply Rules
                        </button>
                        <div class="btn-group admin-only">
                            <button class="btn btn-secondary" id="exportRulesBtn">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-secondary" id="importRulesBtn">
                                <i class="fas fa-upload"></i> Import
                            </button>
                            <input type="file" id="importRulesFile" style="display: none;" accept=".json,.yaml,.yml,.csv">
                        </div>
                        <div class="search-bar" style="flex: 1; margin-left: 20px;">
                            <input type="text" id="ruleSearchInput" placeholder="Search rules..." class="form-control">
                        </div>
                    </div>
                    
                    <div class="rules-container">
                        <table class="rules-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Keywords</th>
                                    <th>Category</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th class="admin-only" id="ruleScopeHeader">Scope</th>
                                    <th class="admin-only" id="ruleActionsHeader">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="rulesBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Categories Page -->
                <div id="categories" class="page">
                    <div class="page-header">
                        <button class="btn btn-primary" id="addCategoryPageBtn">
                            <i class="fas fa-plus"></i> New Category
                        </button>
                    </div>
                    
                    <div class="category-management">
                        <div class="category-list-section">
                            <h3><i class="fas fa-arrow-up"></i> Expense Categories</h3>
                            <ul id="expenseCategoryList" class="category-list">
                                <!-- Populated by JavaScript -->
                            </ul>
                        </div>
                        <div class="category-list-section">
                            <h3><i class="fas fa-arrow-down"></i> Income Categories</h3>
                            <ul id="incomeCategoryList" class="category-list">
                                <!-- Populated by JavaScript -->
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Page -->
                <div id="settings" class="page">
                    <div class="settings-container">
                        <!-- User Management Section (Superuser only) -->
                        <div class="settings-section" id="userManagementSection">
                            <h2><i class="fas fa-users"></i> User Management</h2>
                            <div class="user-management-card">
                                <div class="user-management-header">
                                    <h3>System Users</h3>
                                    <button class="btn btn-primary" id="addUserBtn">
                                        <i class="fas fa-user-plus"></i> Add User
                                    </button>
                                </div>
                                <table class="users-table">
                                    <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Role</th>
                                            <th>Calendar View</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <h2>API Status</h2>
                            <div class="api-status-card">
                                <div class="status-header">
                                    <h3>API Server Control</h3>
                                    <div id="statusBadge">
                                        <span id="statusText">Loading...</span>
                                    </div>
                                </div>
                                
                                <div class="status-details" id="statusDetails">
                                    <div class="detail-row">
                                        <label>Status:</label>
                                        <span class="status-value">Loading...</span>
                                    </div>
                                    <div class="detail-row">
                                        <label>Last Toggled:</label>
                                        <span class="status-value">Never</span>
                                    </div>
                                    <div class="detail-row">
                                        <label>Toggled By:</label>
                                        <span class="status-value">System</span>
                                    </div>
                                </div>
                                
                                <div class="toggle-section">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="apiToggle">
                                        <span class="slider"></span>
                                    </label>
                                    <span class="toggle-label">Toggle API</span>
                                </div>
                                
                                <div id="toggleMessage"></div>
                            </div>
                        </div>
                        
                        <!-- Data Management Section (Superuser only) -->
                        <div class="settings-section superuser-only" id="dataManagementSection">
                            <h2><i class="fas fa-database"></i> Data Management</h2>
                            <div class="data-management-card">
                                <h3>Clear Transactions</h3>
                                <p class="warning-text"><i class="fas fa-exclamation-triangle"></i> Warning: These actions cannot be undone!</p>
                                
                                <div class="clear-options">
                                    <!-- Clear by Date -->
                                    <div class="clear-option">
                                        <h4>Clear by Specific Date</h4>
                                        <div class="clear-form">
                                            <input type="date" id="clearByDatePicker" class="form-control">
                                            <button class="btn btn-warning" id="clearByDateBtn">
                                                <i class="fas fa-calendar-day"></i> Clear Date
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Clear by Period -->
                                    <div class="clear-option">
                                        <h4>Clear by Date Range</h4>
                                        <div class="clear-form">
                                            <input type="date" id="clearPeriodStart" class="form-control" placeholder="Start Date">
                                            <span class="date-separator">to</span>
                                            <input type="date" id="clearPeriodEnd" class="form-control" placeholder="End Date">
                                            <button class="btn btn-warning" id="clearByPeriodBtn">
                                                <i class="fas fa-calendar-week"></i> Clear Period
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Clear All -->
                                    <div class="clear-option clear-all-option">
                                        <h4>Clear All Transactions</h4>
                                        <p>This will permanently delete ALL transactions from the database.</p>
                                        <button class="btn btn-danger" id="clearAllBtn">
                                            <i class="fas fa-trash-alt"></i> Clear All Transactions
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Settings Management Section (Superuser only) -->
                        <div class="settings-section superuser-only" id="settingsManagementSection">
                            <h2><i class="fas fa-cog"></i> Settings Management</h2>
                            <div class="settings-backup-restore-card" style="margin-bottom: 2em;">
                                <div class="settings-backup-actions">
                                    <button class="btn btn-success" id="saveSettingsBtn">
                                        <i class="fas fa-save"></i> Save Settings
                                    </button>
                                    <button class="btn btn-secondary" id="backupSettingsBtn">
                                        <i class="fas fa-download"></i> Back Up Settings
                                    </button>
                                    <label class="btn btn-primary" style="margin-bottom:0;">
                                        <i class="fas fa-upload"></i> Restore Settings
                                        <input type="file" id="restoreSettingsInput" accept="application/json" style="display:none;">
                                    </label>
                                    <hr>
                                    <button class="btn btn-danger" id="resetProfileBtn">
                                        <i class="fas fa-undo"></i> Reset Profile to Default
                                    </button>
                                    <button class="btn btn-secondary" id="backupDbBtn">
                                        <i class="fas fa-database"></i> Back Up Database
                                    </button>
                                    <label class="btn btn-primary" style="margin-bottom:0;">
                                        <i class="fas fa-database"></i> Restore Database
                                        <input type="file" id="restoreDbInput" accept=".db,application/octet-stream" style="display:none;">
                                    </label>
                                </div>
                                <div id="settingsBackupMessage" style="margin-top:0.5em;"></div>
                            </div>
                        </div>

                        <!-- Activity Logs Section -->
                        <div class="settings-section" id="activityLogsSection">
                            <h2><i class="fas fa-history"></i> Activity Logs</h2>
                            </div>
                            
                            <!-- Log Settings Card -->
                            <div class="log-settings-card superuser-only">
                                <h3><i class="fas fa-cog"></i> Logging Configuration</h3>
                                
                                <!-- Master Toggle -->
                                <div class="log-setting-row">
                                    <div class="setting-label">
                                        <strong>Enable Activity Logging</strong>
                                        <p class="setting-description">Master switch to enable or disable all activity logging</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="loggingEnabledToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <!-- What to Log -->
                                <div class="log-setting-group" id="logSettingsGroup">
                                    <h4>What to Log</h4>
                                    <div class="log-checkboxes-row">
                                        <div class="log-checkbox-group">
                                            <strong>Categories:</strong>
                                            <div class="checkbox-list" id="categoryCheckboxes">
                                                <label><input type="checkbox" value="auth" checked> Authentication</label>
                                                <label><input type="checkbox" value="transaction" checked> Transactions</label>
                                                <label><input type="checkbox" value="upload" checked> Uploads</label>
                                                <label><input type="checkbox" value="user" checked> Users</label>
                                                <label><input type="checkbox" value="settings" checked> Settings</label>
                                                <label><input type="checkbox" value="system" checked> System</label>
                                            </div>
                                        </div>
                                        <div class="log-checkbox-group">
                                            <strong>Actions:</strong>
                                            <div class="checkbox-list" id="actionCheckboxes">
                                                <label><input type="checkbox" value="login" checked> Login</label>
                                                <label><input type="checkbox" value="logout" checked> Logout</label>
                                                <label><input type="checkbox" value="create" checked> Create</label>
                                                <label><input type="checkbox" value="update" checked> Update</label>
                                                <label><input type="checkbox" value="delete" checked> Delete</label>
                                                <label><input type="checkbox" value="upload" checked> Upload</label>
                                                <label><input type="checkbox" value="download" checked> Download</label>
                                                <label><input type="checkbox" value="toggle" checked> Toggle</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Retention Settings -->
                                <div class="log-setting-group">
                                    <h4>Log Retention</h4>
                                    <div class="retention-settings">
                                        <div class="form-group inline">
                                            <label for="retentionDays">Keep logs for:</label>
                                            <select id="retentionDays" class="form-control">
                                                <option value="7">7 days</option>
                                                <option value="14">14 days</option>
                                                <option value="30">30 days</option>
                                                <option value="60">60 days</option>
                                                <option value="90" selected>90 days</option>
                                                <option value="180">180 days</option>
                                                <option value="365">1 year</option>
                                            </select>
                                        </div>
                                        <label class="checkbox-inline">
                                            <input type="checkbox" id="autoCleanupToggle" checked>
                                            Auto-cleanup old logs
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Export Settings -->
                                <div class="log-setting-group">
                                    <h4>Export Settings</h4>
                                    <div class="export-settings">
                                        <div class="form-group inline">
                                            <label for="exportFormat">Export format:</label>
                                            <select id="exportFormat" class="form-control">
                                                <option value="csv">CSV</option>
                                                <option value="json">JSON</option>
                                                <option value="txt">Plain Text</option>
                                            </select>
                                        </div>
                                        <button class="btn btn-secondary" id="exportLogsBtn">
                                            <i class="fas fa-download"></i> Export Logs
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- File Logging Destination -->
                                <div class="log-setting-group">
                                    <h4>File Logging Destination</h4>
                                    <div class="log-setting-row">
                                        <div class="setting-label">
                                            <strong>Enable File Logging</strong>
                                            <p class="setting-description">Save logs to a file destination</p>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="fileLoggingToggle">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    
                                    <div class="file-destination-settings" id="fileDestinationSettings" style="display: none;">
                                        <div class="form-group">
                                            <label for="destinationType">Destination Type:</label>
                                            <select id="destinationType" class="form-control">
                                                <option value="local">Local Path</option>
                                                <option value="smb">SMB/CIFS Share</option>
                                                <option value="nfs">NFS Mount</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Local Path Settings -->
                                        <div class="destination-config" id="localPathConfig">
                                            <div class="form-group">
                                                <label for="localLogPath">Log Path:</label>
                                                <input type="text" id="localLogPath" class="form-control" placeholder="e.g., C:\Logs or /var/log/expense-tracker">
                                            </div>
                                        </div>
                                        
                                        <!-- SMB Settings -->
                                        <div class="destination-config" id="smbConfig" style="display: none;">
                                            <div class="form-row">
                                                <div class="form-group">
                                                    <label for="smbServer">Server:</label>
                                                    <input type="text" id="smbServer" class="form-control" placeholder="server.domain.com">
                                                </div>
                                                <div class="form-group">
                                                    <label for="smbShare">Share Name:</label>
                                                    <input type="text" id="smbShare" class="form-control" placeholder="logs$">
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group">
                                                    <label for="smbDomain">Domain:</label>
                                                    <input type="text" id="smbDomain" class="form-control" placeholder="DOMAIN">
                                                </div>
                                                <div class="form-group">
                                                    <label for="smbUsername">Username:</label>
                                                    <input type="text" id="smbUsername" class="form-control" placeholder="username">
                                                </div>
                                                <div class="form-group">
                                                    <label for="smbPassword">Password:</label>
                                                    <input type="password" id="smbPassword" class="form-control" placeholder="••••••••">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- NFS Settings -->
                                        <div class="destination-config" id="nfsConfig" style="display: none;">
                                            <div class="form-row">
                                                <div class="form-group">
                                                    <label for="nfsServer">NFS Server:</label>
                                                    <input type="text" id="nfsServer" class="form-control" placeholder="nfs.domain.com">
                                                </div>
                                                <div class="form-group">
                                                    <label for="nfsExport">Export Path:</label>
                                                    <input type="text" id="nfsExport" class="form-control" placeholder="/exports/logs">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="nfsMountOptions">Mount Options:</label>
                                                <input type="text" id="nfsMountOptions" class="form-control" placeholder="rw,sync,no_subtree_check">
                                            </div>
                                        </div>
                                        
                                        <div class="destination-actions">
                                            <button class="btn btn-secondary" id="testDestinationBtn">
                                                <i class="fas fa-plug"></i> Test Connection
                                            </button>
                                            <button class="btn btn-primary" id="saveLogsToFileBtn">
                                                <i class="fas fa-save"></i> Save Logs Now
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="log-settings-actions">
                                    <button class="btn btn-success" id="saveLogSettingsBtn">
                                        <i class="fas fa-check"></i> Save Settings
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Activity Logs Table -->
                            <div class="activity-logs-card">
                                <div class="activity-logs-filters">
                                    <div class="filter-group">
                                        <label for="activityCategoryFilter">Category:</label>
                                        <select id="activityCategoryFilter" class="form-control">
                                            <option value="">All Categories</option>
                                            <option value="auth">Authentication</option>
                                            <option value="transaction">Transactions</option>
                                            <option value="upload">Uploads</option>
                                            <option value="user">Users</option>
                                            <option value="settings">Settings</option>
                                            <option value="system">System</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label for="activityActionFilter">Action:</label>
                                        <select id="activityActionFilter" class="form-control">
                                            <option value="">All Actions</option>
                                            <option value="login">Login</option>
                                            <option value="logout">Logout</option>
                                            <option value="create">Create</option>
                                            <option value="update">Update</option>
                                            <option value="delete">Delete</option>
                                            <option value="upload">Upload</option>
                                            <option value="download">Download</option>
                                            <option value="toggle">Toggle</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label for="activityDateFilter">Date:</label>
                                        <input type="date" id="activityDateFilter" class="form-control">
                                    </div>
                                    <button class="btn btn-sm btn-primary" id="refreshActivityLogsBtn">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                                
                                <div class="activity-logs-table-container">
                                    <table class="activity-logs-table">
                                        <thead>
                                            <tr>
                                                <th>Time</th>
                                                <th>User</th>
                                                <th>Action</th>
                                                <th>Category</th>
                                                <th>Description</th>
                                                <th>IP Address</th>
                                            </tr>
                                        </thead>
                                        <tbody id="activityLogsBody">
                                            <!-- Populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="activity-logs-pagination">
                                    <button class="btn btn-sm btn-secondary" id="activityPrevPage" disabled>
                                        <i class="fas fa-chevron-left"></i> Previous
                                    </button>
                                    <span id="activityPageInfo">Page 1</span>
                                    <button class="btn btn-sm btn-secondary" id="activityNextPage">
                                        Next <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                
                                <div class="activity-logs-actions superuser-only">
                                    <button class="btn btn-danger btn-sm" id="clearOldLogsBtn">
                                        <i class="fas fa-trash-alt"></i> Clear Old Logs
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Upload Page -->
                <div id="upload" class="page">
                    <div class="upload-container">
                        <div class="upload-box">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h3>Upload Bank Statement</h3>
                            <p>Supported formats: CSV, Excel (XLSX, XLS)</p>
                            
                            <div class="upload-area" id="uploadArea">
                                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" hidden>
                                <p>Drag and drop your file here or <button type="button" class="link-btn" id="browseBtn">browse</button></p>
                            </div>
                            
                            <div id="uploadPreview" class="upload-preview" style="display:none;">
                                <h4>Preview (First 10 rows)</h4>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Type</th>
                                            <th>Category</th>
                                        </tr>
                                    </thead>
                                    <tbody id="previewBody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                                <button class="btn btn-success" id="confirmUploadBtn">
                                    <i class="fas fa-check"></i> Confirm Upload
                                </button>
                                <button class="btn btn-secondary" id="cancelUploadBtn">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                            
                            <div id="uploadStatus" class="upload-status" style="display:none;">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Upload History Section -->
                        <div class="upload-history-section">
                            <div class="section-header">
                                <h3><i class="fas fa-history"></i> Upload History</h3>
                                <button class="btn btn-sm btn-secondary" id="refreshUploadsBtn">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div class="upload-history-table-container">
                                <table class="upload-history-table">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="selectAllUploads"></th>
                                            <th>File Name</th>
                                            <th>Type</th>
                                            <th>Size</th>
                                            <th>Transactions</th>
                                            <th>Uploaded By</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="uploadHistoryBody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                                <div id="noUploadsMessage" class="no-data-message" style="display: none;">
                                    <i class="fas fa-inbox"></i>
                                    <p>No uploads yet. Upload a file to get started.</p>
                                </div>
                            </div>
                            <div class="bulk-upload-actions" id="bulkUploadActions" style="display: none;">
                                <span id="selectedUploadCount">0 selected</span>
                                <button class="btn btn-danger btn-sm" id="deleteSelectedUploadsBtn">
                                    <i class="fas fa-trash"></i> Delete Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Add Transaction</h2>
            <form id="transactionForm">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="transDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="transDesc" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="transType" class="form-control" required>
                        <option value="">Select...</option>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <div class="category-select-wrapper">
                        <select id="transCategory" class="form-control" required>
                            <option value="">Select...</option>
                        </select>
                        <button type="button" class="btn btn-icon-sm" id="addCategoryBtn" title="Add New Category">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" id="transAmount" class="form-control" step="0.01" required>
                </div>
                <div class="form-group" id="statusGroup" style="display: none;">
                    <label>Status</label>
                    <select id="transStatus" class="form-control">
                        <option value="false">Included</option>
                        <option value="true">Excluded</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="transNotes" class="form-control"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Transaction</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('transactionModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Category Modal -->
    <div id="categoryModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeModal('categoryModal')">&times;</span>
            <h2 id="categoryModalTitle">Add New Category</h2>
            <form id="categoryForm">
                <input type="hidden" id="categoryId">
                <input type="hidden" id="categoryParentId">
                <div class="form-group">
                    <label>Category Name</label>
                    <input type="text" id="categoryName" class="form-control" placeholder="e.g., Subscriptions" required>
                </div>
                <div class="form-group" id="categoryTypeGroup">
                    <label>Type</label>
                    <select id="categoryType" class="form-control" required>
                        <option value="">Select...</option>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="color" id="categoryColor" class="form-control" value="#3498db" style="height: 40px; padding: 5px;">
                </div>
                
                <!-- Subcategories Section (shown only when editing parent categories) -->
                <div class="form-group" id="subcategoriesSection" style="display: none;">
                    <label>Subcategories</label>
                    <div id="subcategoriesList" class="subcategories-edit-list">
                        <!-- Populated by JavaScript -->
                    </div>
                    <div class="add-subcategory-inline">
                        <input type="text" id="newSubcategoryName" class="form-control" placeholder="New subcategory name...">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addSubcategoryInline()">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="categorySubmitBtn">Create Category</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('categoryModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Delete Preview Modal -->
    <div id="bulkDeletePreviewModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('bulkDeletePreviewModal')">&times;</span>
            <h2>Confirm Bulk Delete</h2>
            <p id="previewCount" style="font-size: 16px; font-weight: 600; color: var(--danger); margin-bottom: 15px;"></p>
            
            <div id="previewTransactions" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #e9ecef; border-radius: 5px; padding: 10px; background: #f8f9fa;">
                <!-- Populated by JavaScript -->
            </div>
            
            <div class="form-actions">
                <button class="btn btn-danger" onclick="confirmBulkDeleteFromFile()">
                    <i class="fas fa-trash"></i> Delete These Transactions
                </button>
                <button class="btn btn-secondary" onclick="closeModal('bulkDeletePreviewModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Create Budget</h2>
            <form id="budgetForm">
                <div class="form-group">
                    <label>Category</label>
                    <select id="budgetCategory" class="form-control" required>
                        <option value="">Select...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Budget Amount</label>
                    <input type="number" id="budgetAmount" class="form-control" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Period</label>
                    <select id="budgetPeriod" class="form-control" required>
                        <option value="">Select...</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="annual">Annual</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="budgetExcluded">
                        Budget for excluded expenses
                    </label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Create Budget</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('budgetModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Rule Modal -->
    <div id="ruleModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="ruleModalTitle">Add Categorization Rule</h2>
            <form id="ruleForm">
                <div class="form-group">
                    <label>Rule Name</label>
                    <input type="text" id="ruleName" class="form-control" placeholder="e.g., Grocery Stores" required>
                </div>
                <div class="form-group">
                    <label>Keywords (comma-separated)</label>
                    <textarea id="ruleKeywords" class="form-control" placeholder="e.g., whole foods, safeway, trader joes" required rows="3"></textarea>
                    <small>Transactions matching any of these keywords will be categorized accordingly</small>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="ruleCategory" class="form-control" required>
                        <option value="">Select...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Priority</label>
                    <input type="number" id="rulePriority" class="form-control" value="0" min="-100" max="100">
                    <small>Higher priority rules are checked first</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="ruleActive" checked>
                        Active
                    </label>
                </div>
                <div class="form-group" id="ruleScopeGroup">
                    <label>Save For</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="ruleScope" value="all" id="ruleScopeAll" checked>
                            <span>All Users &mdash; <small>default rule applied to every user</small></span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="ruleScope" value="self" id="ruleScopeSelf">
                            <span>Myself Only &mdash; <small>personal rule, overrides the default for your account</small></span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Test Rule</label>
                    <input type="text" id="ruleTestInput" class="form-control" placeholder="Enter a transaction description to test...">
                    <div id="ruleTestResult" style="margin-top: 10px; display: none;"></div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Rule</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('ruleModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <span class="close" onclick="closeModal('userModal')">&times;</span>
            <h2 id="userModalTitle">Add User</h2>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="userUsername" class="form-control" placeholder="Enter username" required minlength="3">
                </div>
                <div class="form-group" id="userPasswordGroup">
                    <label>Password</label>
                    <input type="password" id="userPassword" class="form-control" placeholder="Enter password" minlength="4">
                    <small id="passwordHint">Leave blank to keep current password (edit mode)</small>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="userRole" class="form-control" required>
                        <option value="viewer">Viewer (Read-only)</option>
                        <option value="standard">Standard (Full access)</option>
                        <option value="superuser">Super User (Admin access)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Calendar View</label>
                    <select id="userCalendarPreference" class="form-control" required>
                        <option value="both">Both (Gregorian & Badí')</option>
                        <option value="gregorian">Gregorian Only</option>
                        <option value="badi">Badí' (Bahá'í) Only</option>
                    </select>
                    <small class="form-text text-muted">Determines which calendar options are available for this user</small>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="userSubmitBtn">Create User</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="closeModal('changePasswordModal')">&times;</span>
            <h2><i class="fas fa-key"></i> Change Password</h2>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label>Current Password</label>
                    <input type="password" id="currentPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="newPassword" class="form-control" required minlength="4">
                </div>
                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" id="confirmPassword" class="form-control" required minlength="4">
                </div>
                <div id="passwordError" class="login-error" style="display: none;"></div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Change Password</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('changePasswordModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Clear Transactions Confirmation Modal -->
    <div id="clearTransactionsModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <span class="close" onclick="closeModal('clearTransactionsModal')">&times;</span>
            <h2><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Confirm Deletion</h2>
            <div class="confirm-delete-content">
                <p id="clearTransactionsMessage">Are you sure you want to delete these transactions?</p>
                <p class="transaction-count"><strong id="clearTransactionsCount">0</strong> transaction(s) will be permanently deleted.</p>
                <p class="warning-text">This action cannot be undone!</p>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-danger" id="confirmClearBtn">
                    <i class="fas fa-trash-alt"></i> Yes, Delete
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('clearTransactionsModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Upload Confirmation Modal -->
    <div id="deleteUploadModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <span class="close" onclick="closeModal('deleteUploadModal')">&times;</span>
            <h2><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Delete Upload</h2>
            <div class="confirm-delete-content">
                <p id="deleteUploadMessage">Are you sure you want to delete this upload?</p>
                <p class="transaction-count"><strong id="deleteUploadTransactionCount">0</strong> transaction(s) will be permanently deleted.</p>
                <p class="warning-text">This action cannot be undone!</p>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-danger" id="confirmDeleteUploadBtn">
                    <i class="fas fa-trash-alt"></i> Yes, Delete
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('deleteUploadModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="/static/js/app.js?v=12"></script>
</body>
</html>
